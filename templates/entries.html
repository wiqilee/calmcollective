{% extends "layout.html" %}

{% macro fmt_score(x) -%}
  {%- if x is number -%}
    {%- set r2 = (x|round(2)) -%}
    {%- if r2 == (r2|round(0)) -%}
      {{ r2|int }}
    {%- elif (r2*10)|round(0) == r2*10 -%}
      {{ '%.1f'|format(r2) }}
    {%- else -%}
      {{ '%.2f'|format(r2) }}
    {%- endif -%}
  {%- else -%}
    {{ x }}
  {%- endif -%}
{%- endmacro %}

{% block content %}
<section class="card">
  <h2>Your Entries</h2>

  <!-- Filter bar -->
  <form method="GET" action="{{ url_for('entries') }}" class="grid" style="margin:8px 0 12px;">
    <label>Flavor
      <select name="flavor" aria-label="Filter by flavor">
        <option value="" {% if not current_flavor %}selected{% endif %}>All</option>
        {% for opt, label in flavor_labels.items() %}
          <option value="{{ opt }}" {% if current_flavor==opt %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </label>

    <label>Start date
      <input type="date" name="start" value="{{ current_start }}">
    </label>

    <label>End date
      <input type="date" name="end" value="{{ current_end }}">
    </label>

    <div style="align-self:end;">
      <button class="secondary" type="submit">Apply</button>
      <a class="secondary" href="{{ url_for('entries') }}" style="margin-left:8px;">Clear</a>
    </div>
  </form>

  <!-- Fixed-height chart wrapper so the canvas doesn't stretch the page -->
  <div class="chart-wrap" aria-label="Mood trend over time">
    <canvas id="moodChart"></canvas>
  </div>

  {% if not entries %}
    <p>No entries yet. Write your first one on the Journal page.</p>
  {% else %}
    <div class="entries">
      {% for e in entries|reverse %}
        {% set mood = (e.mood_slider or 0)|float %}
        {% set mood_class = 'mood-low' if mood <= 3 else ('mood-mid' if mood <= 6 else 'mood-high') %}

        <article class="entry">
          <header class="entry-header">
            <div class="ts">{{ e.timestamp }}</div>

            <!-- Friendly flavor label -->
            <div class="tag">
              {{ flavor_labels.get(e.flavor, e.flavor) }}
            </div>

            <!-- Color-coded mood badge -->
            <div class="mood-pill {{ mood_class }}" aria-label="Mood score">
              Mood: {{ '%.1f'|format(mood) }}
            </div>
          </header>

          <!-- Small action row (Delete) -->
          <div class="entry-actions">
            <form method="POST"
                  action="{{ url_for('delete_entry') }}"
                  onsubmit="return confirmDelete('{{ e.timestamp|e }}')">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <!-- MUST be 'ts' to match app.py -->
              <input type="hidden" name="ts" value="{{ e.timestamp }}">
              <button type="submit" class="btn-danger" aria-label="Delete this entry">Delete</button>
            </form>
          </div>

          <!-- Crisis alert (per entry) -->
          {% if e.analysis and e.analysis.signals and e.analysis.signals.crisis %}
          <div class="crisis-alert" role="alert" aria-live="assertive">
            <strong>⚠ Crisis notice:</strong>
            If you are in immediate danger or thinking about harming yourself, please seek urgent help now.
            {% if settings.get('emergency_contact_value') %}
              <span class="crisis-contact">
                Contact {{ settings.get('emergency_contact_label','someone you trust') }}:
                <a href="tel:{{ settings.get('emergency_contact_value') }}">{{ settings.get('emergency_contact_value') }}</a>
              </span>
            {% endif %}
          </div>
          {% endif %}

          <!-- User text -->
          <p class="text">{{ e.text }}</p>

          <!-- Insights -->
          <div class="insights">
            <div class="scoreline">
              <span class="score">Mood score: {{ fmt_score(e.analysis.mood_score) }}</span>
              <span class="pn">+{{ e.analysis.positive }} / -{{ e.analysis.negative }}</span>
            </div>

            <!-- Suggestions list -->
            {% if e.support and e.support|length > 0 %}
              <h4 class="section-title">Suggestions</h4>
              <ul class="support">
                {% for s in e.support %}
                  <li>{{ s }}</li>
                {% endfor %}
              </ul>
            {% endif %}

            <!-- Supportive note -->
            {% if e.quote %}
              <figure class="quote-card quote-support">
                <blockquote>“{{ e.quote }}”</blockquote>
                <figcaption>Supportive note</figcaption>
              </figure>
            {% endif %}

            <!-- Spiritual note -->
            {% if e.spiritual %}
              <figure class="quote-card quote-spiritual">
                <blockquote>“{{ e.spiritual }}”</blockquote>
                <figcaption>Spiritual note</figcaption>
              </figure>
            {% endif %}

            <!-- Wisdom with author -->
            {% if e.wisdom %}
              <figure class="quote-card quote-wisdom">
                <blockquote>“{{ e.wisdom.text }}”</blockquote>
                <figcaption><em>— {{ e.wisdom.author }}</em></figcaption>
              </figure>
            {% endif %}
          </div>
        </article>
      {% endfor %}
    </div>
  {% endif %}
</section>

<!-- Minimal inline hooks (you can move these to styles.css later) -->
<style>
  .entry-header { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .entry-actions { margin: 6px 0 10px; }
  .entry-actions form { display: inline-block; }

  .tag { padding:2px 8px; border-radius:999px; background:rgba(255,255,255,0.08); font-size:12px; }
  .mood-pill { margin-left:auto; padding:2px 10px; border-radius:999px; font-size:12px; font-weight:600; }
  .mood-low  { background:#3b0f14; color:#ff6b6b; }   /* 0–3 */
  .mood-mid  { background:#3a3108; color:#ffd166; }   /* 4–6 */
  .mood-high { background:#0f2e1a; color:#4ade80; }   /* 7–10 */
  .section-title { margin:10px 0 4px; opacity:0.9; font-size:14px; }
  .quote-card { margin:10px 0; padding:10px 12px; border-radius:12px; background:rgba(255,255,255,0.04); }
  .quote-card blockquote { margin:0; font-style:italic; }
  .quote-card figcaption { margin-top:6px; font-size:12px; opacity:0.7; }
  .quote-support { border-left:3px solid #60a5fa; padding-left:10px; }
  .quote-spiritual { border-left:3px solid #a78bfa; padding-left:10px; }
  .quote-wisdom { border-left:3px solid #34d399; padding-left:10px; }
  .scoreline { display:flex; gap:10px; align-items:center; flex-wrap:wrap; opacity:0.9; }
  .support { margin:6px 0 0 16px; }

  .btn-danger {
    background:#dc2626; color:#fff; border:none; padding:4px 10px;
    border-radius:8px; font-size:12px; cursor:pointer;
  }
  .btn-danger:hover { background:#b91c1c; }

  .chart-wrap { height: 260px; width: 100%; margin: 8px 0 16px; }
  .chart-wrap canvas { width: 100% !important; height: 100% !important; display: block; }

  .crisis-alert {
    margin: 10px 0 8px; padding: 10px 12px;
    border: 1px solid rgba(248,114,114,0.4);
    background: rgba(248,114,114,0.10);
    color: #ffd9d9; border-radius: 10px; line-height: 1.45;
  }
  .crisis-alert .crisis-contact { display: inline-block; margin-left: 8px; }
</style>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin="anonymous"></script>

<!-- Chart with same filters as the page -->
<script>
function confirmDelete(ts){
  return confirm('Delete this entry?\nTimestamp: ' + ts);
}

(async function drawChart(){
  try {
    const apiUrl = "{{ url_for('api_entries', flavor=current_flavor, start=current_start, end=current_end, limit=90) }}";
    const res = await fetch(apiUrl);
    const raw = await res.json();

    // Sort ascending by timestamp to draw left -> right
    const data = [...raw].sort((a,b) => String(a.timestamp||'').localeCompare(String(b.timestamp||'')));

    const labels = data.map(e => {
      const t = e.timestamp || '';
      const d = new Date(t.replace(' ', 'T'));
      return isNaN(d) ? t.replace('T',' ') : d.toLocaleString([], {
        year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'
      });
    });
    const moods = data.map(e => Number(e.mood_slider || 0));

    const canvas = document.getElementById('moodChart');
    const ctx = canvas.getContext('2d');
    if (!moods.length) { ctx.font = "12px system-ui"; ctx.fillStyle = "rgba(255,255,255,.6)"; ctx.fillText("No data yet", 10, 20); return; }

    const lineColor = '#60a5fa';
    const fillGrad  = ctx.createLinearGradient(0, 0, 0, canvas.height);
    fillGrad.addColorStop(0, 'rgba(96,165,250,0.25)');
    fillGrad.addColorStop(1, 'rgba(96,165,250,0.00)');

    const pointColors = moods.map(v => v <= 3 ? '#ff6b6b' : (v <= 6 ? '#ffd166' : '#4ade80'));

    const bandsPlugin = {
      id: 'moodBands',
      beforeDraw(chart) {
        const {ctx, chartArea, scales: {y}} = chart;
        if (!y) return;
        ctx.save();
        const ranges = [
          {from: 0, to: 3, color: 'rgba(239,68,68,0.08)'},
          {from: 3, to: 6, color: 'rgba(245,158,11,0.07)'},
          {from: 6, to: 10, color: 'rgba(34,197,94,0.06)'}
        ];
        ranges.forEach(r => {
          const yTop = y.getPixelForValue(r.to);
          const yBot = y.getPixelForValue(r.from);
          ctx.fillStyle = r.color;
          ctx.fillRect(chartArea.left, yTop, chartArea.right - chartArea.left, yBot - yTop);
        });
        ctx.restore();
      }
    };

    new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Mood',
          data: moods,
          borderColor: lineColor,
          backgroundColor: fillGrad,
          fill: true,
          borderWidth: 2,
          tension: 0.3,
          pointRadius: 3,
          pointHoverRadius: 5,
          pointBackgroundColor: pointColors,
          pointBorderColor: '#0b1220',
          pointBorderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        animation: { duration: 350 },
        layout: { padding: { left: 4, right: 8, top: 8, bottom: 0 } },
        scales: {
          x: { grid: { color: 'rgba(255,255,255,0.06)' },
               ticks: { color: 'rgba(255,255,255,0.7)', maxRotation: 0, autoSkip: true } },
          y: { min: 0, max: 10,
               ticks: { stepSize: 1, color: 'rgba(255,255,255,0.7)' },
               grid: { color: 'rgba(255,255,255,0.08)' },
               border: { display: false } }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(17,24,39,0.92)',
            borderColor: 'rgba(255,255,255,0.15)',
            borderWidth: 1,
            padding: 10,
            displayColors: false,
            callbacks: {
              title: (items) => items[0]?.label || '',
              label: (ctx) => `Mood: ${ctx.parsed.y} / 10`
            }
          }
        }
      },
      plugins: [bandsPlugin]
    });
  } catch (e) {
    console.error('Chart error', e);
  }
})();
</script>
{% endblock %}

{% block extra_footer %}
<!-- Breathing timer (Entries page only) -->
<script>
(function(){
  const footer = document.querySelector('.footer');
  if(!footer) return;

  let i = 0;
  const steps = [
    "Breathe in… 4 seconds",
    "Hold… 4 seconds",
    "Slow exhale… 6 seconds",
    "Rest… 2 seconds"
  ];
  const node = document.createElement('div');
  node.style.marginTop = '8px';
  node.style.opacity = '0.8';
  footer.appendChild(node);

  node.textContent = steps[0];
  i = 1;

  setInterval(() => {
    node.textContent = steps[i % steps.length];
    i++;
  }, 4000);
})();
</script>
{% endblock %}
